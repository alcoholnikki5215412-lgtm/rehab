<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŠ¨æ€æ’è¯¾ç³»ç»Ÿ - æ™ºèƒ½å°Šäº«ç‰ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#64748b',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-in': 'slideIn 0.3s ease-out',
            'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideIn: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .card-shadow { @apply shadow-lg hover:shadow-xl transition-shadow duration-300; }
      .btn-primary { @apply bg-primary text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors duration-300 shadow-sm; }
      .btn-secondary { @apply bg-secondary text-white px-4 py-2 rounded-md hover:bg-slate-600 transition-colors duration-300 shadow-sm; }
      .btn-danger { @apply bg-danger text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors duration-300 shadow-sm; }
      .btn-outline { @apply border border-gray-300 text-gray-700 bg-white px-4 py-2 rounded-md hover:bg-gray-50 transition-colors duration-300; }
      
      /* è¯¾ç¨‹ç‰¹å®šé¢œè‰²æ ·å¼ */
      .course-pt { @apply bg-red-50 border-red-200 text-red-800; }
      .course-pt .badge { @apply bg-red-100 text-red-700; }
      
      .course-xuandiao { @apply bg-yellow-50 border-yellow-200 text-yellow-800; }
      .course-xuandiao .badge { @apply bg-yellow-100 text-yellow-700; }
      
      .course-lvdong { @apply bg-blue-50 border-blue-200 text-blue-800; }
      .course-lvdong .badge { @apply bg-blue-100 text-blue-700; }
      
      .course-tunyan { @apply bg-green-50 border-green-200 text-green-800; }
      .course-tunyan .badge { @apply bg-green-100 text-green-700; }

      .course-default { @apply bg-gray-50 border-gray-200 text-gray-800; }
      .course-default .badge { @apply bg-gray-200 text-gray-700; }
      
      /* å†²çªæ ·å¼ */
      .conflict-card { @apply ring-2 ring-red-500 ring-offset-1; }
      .conflict-text { @apply text-red-600 font-bold animate-pulse-fast; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20 font-sans">
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between">
      <div class="flex items-center mb-3 md:mb-0">
        <div class="bg-primary text-white p-2 rounded-lg mr-3">
            <i class="fa fa-calendar-check-o text-xl"></i>
        </div>
        <div>
            <h1 class="text-xl font-bold text-gray-800 tracking-tight">æ™ºèƒ½æ’è¯¾ç³»ç»Ÿ <span class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full ml-1">Pro+</span></h1>
            <p class="text-xs text-gray-500">æ—¥æœŸåŒæ­¥ Â· è‡ªåŠ¨æ’è¯¾ Â· å†²çªæ£€æµ‹</p>
        </div>
      </div>
      
      <div class="flex items-center space-x-2 bg-gray-50 p-1 rounded-lg border border-gray-200">
        <button id="prevWeekBtn" class="p-2 text-gray-500 hover:text-primary transition-colors"><i class="fa fa-chevron-left"></i></button>
        <div class="flex flex-col items-center px-2 cursor-pointer" id="resetDateBtn" title="å›åˆ°ä»Šå¤©">
           <span class="text-xs text-gray-400">å½“å‰æŸ¥çœ‹</span>
           <span id="headerDateDisplay" class="font-bold text-gray-800 leading-tight min-w-[100px] text-center">--</span>
        </div>
        <button id="nextWeekBtn" class="p-2 text-gray-500 hover:text-primary transition-colors"><i class="fa fa-chevron-right"></i></button>
      </div>
      
      <div class="flex flex-wrap gap-2 mt-3 md:mt-0 justify-center">
        <button id="showAllStudentsBtn" class="btn-outline text-sm">
          <i class="fa fa-list mr-1"></i> å…¨éƒ¨åå•
        </button>
        <button id="teacherManagementBtn" class="btn-outline text-sm">
          <i class="fa fa-users mr-1"></i> æ•™å¸ˆæ—¥ç¨‹
        </button>
        <button id="addStudentBtn" class="btn-primary text-sm shadow-lg shadow-blue-500/30">
          <i class="fa fa-plus mr-1"></i> æ’è¯¾
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <div class="mb-6 overflow-x-auto pb-2">
      <div class="flex justify-between space-x-2 min-w-[600px]" id="weekNavContainer">
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <div class="lg:col-span-1 space-y-6">
        
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
           <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">è¯¾ç¨‹é¢œè‰²è¯´æ˜</h2>
           <div class="grid grid-cols-2 gap-2 text-sm">
             <div class="flex items-center"><div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div> PTè¯¾</div>
             <div class="flex items-center"><div class="w-3 h-3 rounded-full bg-yellow-400 mr-2"></div> æ‚¬åŠè¯¾</div>
             <div class="flex items-center"><div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div> å¾‹åŠ¨è¯¾</div>
             <div class="flex items-center"><div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div> åå’½è¯¾</div>
           </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
           <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center justify-between">
             <span><i class="fa fa-check-square-o text-primary mr-2"></i> ä»Šæ—¥è€ƒå‹¤</span>
           </h2>
           <button id="openStatusModalBtn" class="w-full bg-indigo-50 text-indigo-700 hover:bg-indigo-100 py-3 px-4 rounded-lg flex items-center justify-between transition-colors mb-3">
             <span class="font-medium">ç®¡ç†è¯·å‡ / ç­¾åˆ°</span>
             <i class="fa fa-angle-right"></i>
           </button>
           <div class="flex justify-between text-center divide-x">
              <div class="flex-1 px-2">
                <div class="text-xs text-gray-500">åº”åˆ°</div>
                <div class="text-xl font-bold text-gray-800" id="totalStudents">0</div>
              </div>
              <div class="flex-1 px-2">
                <div class="text-xs text-gray-500">å®åˆ°</div>
                <div class="text-xl font-bold text-success" id="presentStudents">0</div>
              </div>
              <div class="flex-1 px-2">
                <div class="text-xs text-gray-500">è¯·å‡</div>
                <div class="text-xl font-bold text-danger" id="sidebarAbsentCount">0</div>
              </div>
           </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
          <h2 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fa fa-filter text-gray-400 mr-2"></i> å¿«é€Ÿç­›é€‰
          </h2>
          <select id="teacherFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 border mb-3">
            <option value="all">æ‰€æœ‰æ•™å¸ˆ</option>
            </select>
        </div>
      </div>
      
      <div class="lg:col-span-3">
        <div class="bg-white rounded-xl shadow-md overflow-hidden min-h-[600px]">
          <div class="bg-gradient-to-r from-gray-50 to-white px-6 py-4 border-b flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-gray-800" id="timetableTitle">è¯¾ç¨‹è¡¨</h2>
                <p class="text-sm text-gray-500" id="timetableSubtitle">--</p>
            </div>
            <div id="conflictAlert" class="hidden flex items-center bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold animate-pulse">
                <i class="fa fa-exclamation-triangle mr-1"></i> æ£€æµ‹åˆ°æ’è¯¾å†²çª
            </div>
          </div>
          <div class="p-6 bg-gray-50/50">
            <div id="timetableContent" class="space-y-6">
               </div>
            <div id="noCoursesMessage" class="hidden flex flex-col items-center justify-center py-20 text-center">
              <div class="bg-white p-6 rounded-full shadow-sm mb-4"><i class="fa fa-coffee text-gray-300 text-5xl"></i></div>
              <h3 class="text-xl font-medium text-gray-700 mb-1">ä»Šæ—¥æš‚æ— è¯¾ç¨‹</h3>
              <p class="text-gray-400 text-sm">ç‚¹å‡»å³ä¸Šè§’â€œæ’è¯¾â€æ·»åŠ å®‰æ’</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-white border-t mt-8">
    <div class="container mx-auto px-4 py-6 flex flex-col md:flex-row items-center justify-between">
      <div class="text-sm text-gray-400 mb-4 md:mb-0">
        Â© 2025 åŠ¨æ€æ’è¯¾ç³»ç»Ÿ | æ•°æ®è‡ªåŠ¨ä¿å­˜äºæœ¬åœ°
      </div>
      <div class="flex items-center space-x-3">
        <button id="exportDataBtn" class="px-3 py-1 text-sm border rounded hover:bg-gray-50 text-gray-600"><i class="fa fa-download mr-1"></i>å¤‡ä»½</button>
        <button onclick="document.getElementById('importFile').click()" class="px-3 py-1 text-sm border rounded hover:bg-gray-50 text-gray-600"><i class="fa fa-upload mr-1"></i>æ¢å¤</button>
        <input type="file" id="importFile" class="hidden" accept=".json">
      </div>
    </div>
  </footer>

  <div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 h-[80vh] flex flex-col animate-slide-in">
      <div class="border-b px-6 py-4 flex justify-between items-center">
        <h3 class="text-lg font-bold text-gray-800">ä»Šæ—¥å­¦ç”ŸçŠ¶æ€</h3>
        <button id="closeStatusModal" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
      </div>
      <div class="flex border-b">
        <button class="flex-1 py-3 text-center font-medium border-b-2 border-primary text-primary" id="tabAbsent">è¯·å‡ / ç¼ºå‹¤</button>
        <button class="flex-1 py-3 text-center font-medium text-gray-500 hover:bg-gray-50" id="tabPresent">æ­£å¸¸ä¸Šè¯¾</button>
      </div>
      <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
        <div id="absentListPanel" class="space-y-3"></div>
        <div id="presentListPanel" class="hidden space-y-3"></div>
      </div>
    </div>
  </div>

  <div id="allStudentsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 h-[85vh] flex flex-col animate-slide-in">
        <div class="border-b px-6 py-4 flex justify-between items-center bg-gray-50 rounded-t-xl">
            <h3 class="text-lg font-bold text-gray-800"><i class="fa fa-list mr-2 text-primary"></i>å…¨éƒ¨å­¦ç”Ÿæ€»è¡¨</h3>
            <button onclick="document.getElementById('allStudentsModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
        </div>
        <div class="p-4 border-b flex gap-2">
            <input type="text" id="searchAllInput" placeholder="æœç´¢å§“å..." class="border rounded px-3 py-2 text-sm w-64">
        </div>
        <div class="flex-1 overflow-auto p-0">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0">
                    <tr>
                        <th class="px-6 py-3 border-b">å­¦ç”Ÿå§“å</th>
                        <th class="px-6 py-3 border-b">è¯¾ç¨‹ç±»å‹</th>
                        <th class="px-6 py-3 border-b">ä¸Šè¯¾æ—¶é—´</th>
                        <th class="px-6 py-3 border-b">è´Ÿè´£æ•™å¸ˆ</th>
                        <th class="px-6 py-3 border-b">ä¸Šè¯¾æ—¥</th>
                        <th class="px-6 py-3 border-b text-right">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="allStudentsTableBody" class="text-sm divide-y divide-gray-100">
                    </tbody>
            </table>
        </div>
    </div>
  </div>

  <div id="addStudentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 animate-slide-in overflow-hidden flex flex-col max-h-[90vh]">
      <div class="border-b px-6 py-4 flex justify-between items-center bg-blue-50">
        <h3 class="text-lg font-bold text-blue-900" id="addModalTitle">æ·»åŠ å­¦ç”Ÿä¿¡æ¯</h3>
        <button id="closeAddStudentModal" class="text-blue-300 hover:text-blue-500"><i class="fa fa-times"></i></button>
      </div>
      
      <div class="p-6 overflow-y-auto">
        <form id="studentForm" class="space-y-4">
          <input type="hidden" id="formStudentId">
          
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">å­¦ç”Ÿå§“å <span class="text-danger">*</span></label>
            <div class="flex gap-2">
                <input type="text" id="formName" name="name" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" required placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰">
            </div>
          </div>

          <div>
             <label class="block text-sm font-medium mb-1 text-gray-700">è¯¾ç¨‹ç±»å‹ <span class="text-danger">*</span></label>
             <select id="formType" name="classType" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" required>
                <option value="ptè¯¾">ğŸ”´ PTè¯¾ (1å¯¹1)</option>
                <option value="æ‚¬åŠè¯¾">ğŸŸ¡ æ‚¬åŠè¯¾ (1å¯¹2)</option>
                <option value="å¾‹åŠ¨è¯¾">ğŸ”µ å¾‹åŠ¨è¯¾</option>
                <option value="åå’½è¯¾">ğŸŸ¢ åå’½è¯¾ (1å¯¹1)</option>
             </select>
          </div>

          <div class="bg-orange-50 border border-orange-100 p-3 rounded-lg">
             <div class="flex justify-between items-center mb-2">
                <span class="text-orange-800 text-sm font-bold"><i class="fa fa-magic mr-1"></i> æ–°ç”Ÿæ’è¯¾</span>
                <button type="button" id="btnAutoSchedule" class="text-xs bg-orange-200 text-orange-800 px-2 py-1 rounded hover:bg-orange-300 transition">ä¸€é”®éšæœºåˆ†é…</button>
             </div>
             <p class="text-xs text-orange-600">ç‚¹å‡»â€œä¸€é”®éšæœºâ€ç³»ç»Ÿå°†è‡ªåŠ¨æŸ¥æ‰¾æœªæ’è¯¾çš„ç©ºé—²è€å¸ˆå’Œæ—¶é—´ã€‚</p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">ä¸Šè¯¾æ—¶é—´ <span class="text-danger">*</span></label>
              <select id="formTime" name="classTime" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white" required></select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">è´Ÿè´£æ•™å¸ˆ <span class="text-danger">*</span></label>
              <select id="formTeacher" name="teacherId" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white" required></select>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">é‡å¤ä¸Šè¯¾æ—¥ <span class="text-danger">*</span></label>
            <div class="flex flex-wrap gap-2 text-sm select-none" id="weekCheckboxes">
               </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">å¤‡æ³¨</label>
            <textarea id="formNotes" name="notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
          </div>

          <div class="pt-2 flex gap-3">
            <button type="button" id="btnDeleteStudent" class="btn-danger hidden flex-1">åˆ é™¤è¯¾ç¨‹</button>
            <button type="submit" class="btn-primary flex-1 shadow-lg shadow-blue-500/30">ä¿å­˜æ’è¯¾</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="teacherManagementModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden backdrop-blur-sm">
      <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 h-[80vh] flex flex-col">
          <div class="border-b px-6 py-4 flex justify-between items-center">
              <h3 class="text-lg font-bold text-gray-800">æ•™å¸ˆä»Šæ—¥æ—¥ç¨‹</h3>
              <button onclick="document.getElementById('teacherManagementModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
          </div>
          <div id="teacherList" class="p-6 overflow-y-auto flex-1 space-y-4 bg-gray-50"></div>
      </div>
  </div>

  <script>
    // --- æ ¸å¿ƒæ•°æ®ç»“æ„ ---
    const appState = {
      currentViewDate: new Date(), // å½“å‰è§†å›¾é€‰ä¸­çš„å…·ä½“æŸä¸€å¤©
      students: [],
      teachers: [
        { id: 1, name: 'è”¡è€å¸ˆ' }, { id: 2, name: 'ç’ç’è€å¸ˆ' }, { id: 3, name: 'è‘›è€å¸ˆ' },
        { id: 4, name: 'æµ·ç‡•è€å¸ˆ' }, { id: 5, name: 'å­çº¯è€å¸ˆ' }
      ],
      timeSlots: [
        { id: 1, time: '08:00-08:30' }, { id: 2, time: '08:30-09:00' }, { id: 3, time: '09:00-09:30' },
        { id: 4, time: '09:30-10:00' }, { id: 5, time: '10:00-10:30' }, { id: 6, time: '10:30-11:00' },
        { id: 7, time: '13:00-13:30' }, { id: 8, time: '13:30-14:00' }, { id: 9, time: '14:00-14:30' },
        { id: 10, time: '14:30-15:00' }, { id: 11, time: '15:00-15:30' }, { id: 12, time: '15:30-16:00' }
      ],
      // è¯¾ç¨‹æ ·å¼æ˜ å°„
      courseStyles: {
        'ptè¯¾': 'course-pt',
        'æ‚¬åŠè¯¾': 'course-xuandiao',
        'å¾‹åŠ¨è¯¾': 'course-lvdong',
        'åå’½è¯¾': 'course-tunyan'
      }
    };

    // --- æ—¥æœŸå·¥å…·åº“ ---
    const dateUtils = {
      // è·å–æŸä¸ªæ—¥æœŸçš„ 'YYYY-MM-DD' å­—ç¬¦ä¸²
      formatDateStr: (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      },
      // è·å–å±•ç¤ºç”¨çš„æ—¥æœŸ (12-08)
      formatDisplayDate: (date) => {
        return `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      },
      // è·å–æŸä¸ªæ—¥æœŸæ‰€åœ¨å‘¨çš„å‘¨ä¸€
      getMonday: (d) => {
        const date = new Date(d);
        const day = date.getDay();
        const diff = date.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(date.setDate(diff));
      },
      // å¢åŠ å¤©æ•°
      addDays: (date, days) => {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
      },
      getDayName: (dayIndex) => ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][dayIndex]
    };

    // --- åˆå§‹åŒ–ä¸æŒä¹…åŒ– ---
    function init() {
      const saved = localStorage.getItem('timetableDataPro');
      if (saved) appState.students = JSON.parse(saved);
      
      // é»˜è®¤é€‰ä¸­ä»Šå¤©
      appState.currentViewDate = new Date();
      
      initFormOptions();
      updateUI();
      bindEvents();
    }

    function saveData() {
      localStorage.setItem('timetableDataPro', JSON.stringify(appState.students));
    }

    function initFormOptions() {
      const timeSelect = document.getElementById('formTime');
      timeSelect.innerHTML = '';
      appState.timeSlots.forEach(s => timeSelect.innerHTML += `<option value="${s.id}">${s.time}</option>`);
      
      const teacherSelect = document.getElementById('formTeacher');
      teacherSelect.innerHTML = '';
      appState.teachers.forEach(t => teacherSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`);
      
      // æ•™å¸ˆè¿‡æ»¤å™¨
      const filterSelect = document.getElementById('teacherFilter');
      appState.teachers.forEach(t => filterSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`);

      const weekContainer = document.getElementById('weekCheckboxes');
      weekContainer.innerHTML = '';
      ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].forEach((d, i) => {
        // i+1 å¯¹åº”å‘¨ä¸€(1) åˆ° å‘¨æ—¥(7)
        const val = i + 1;
        weekContainer.innerHTML += `
          <label class="flex items-center space-x-1 bg-gray-50 border border-gray-200 px-3 py-2 rounded cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition select-none">
            <input type="checkbox" name="days" value="${val}" class="text-primary rounded"><span>å‘¨${d}</span>
          </label>`;
      });
    }

    // --- æ ¸å¿ƒ UI æ¸²æŸ“ ---
    function updateUI() {
      renderWeekNav();
      renderTimetable();
      updateStats();
    }

    // æ¸²æŸ“æ˜ŸæœŸå¯¼èˆªæ¡ï¼ˆå¸¦å…·ä½“æ—¥æœŸï¼‰
    function renderWeekNav() {
      const container = document.getElementById('weekNavContainer');
      container.innerHTML = '';
      
      const currentMonday = dateUtils.getMonday(appState.currentViewDate);
      const currentSelectedStr = dateUtils.formatDateStr(appState.currentViewDate);

      // é¡¶éƒ¨æ—¥æœŸæ˜¾ç¤º
      document.getElementById('headerDateDisplay').innerHTML = `
        <div class="text-sm">${appState.currentViewDate.getFullYear()}</div>
        <div class="text-lg">${dateUtils.formatDisplayDate(appState.currentViewDate)}</div>
      `;

      for (let i = 0; i < 7; i++) {
        const dateObj = dateUtils.addDays(currentMonday, i);
        const dateStr = dateUtils.formatDateStr(dateObj);
        const isSelected = dateStr === currentSelectedStr;
        const isToday = dateStr === dateUtils.formatDateStr(new Date());
        
        // å‘¨å‡  (1-7, å‘¨æ—¥ä¸º7)
        let dayOfWeek = dateObj.getDay();
        if(dayOfWeek === 0) dayOfWeek = 7;

        const btn = document.createElement('button');
        btn.className = `flex-1 flex flex-col items-center justify-center py-2 px-1 rounded-lg transition-all duration-300 border-2 ${isSelected 
          ? 'bg-primary text-white border-primary shadow-md transform scale-105' 
          : 'bg-white text-gray-600 border-transparent hover:bg-gray-50'}`;
        
        if (isToday && !isSelected) btn.classList.add('border-blue-200', 'bg-blue-50');

        btn.innerHTML = `
          <span class="text-xs font-medium mb-1 opacity-80">${['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][dateObj.getDay()]}</span>
          <span class="text-sm font-bold">${dateUtils.formatDisplayDate(dateObj)}</span>
        `;
        
        btn.onclick = () => {
          appState.currentViewDate = dateObj;
          updateUI();
        };
        
        container.appendChild(btn);
      }
    }

    // æ¸²æŸ“ä¸»è¯¾è¡¨ (å«æ’è¯¾é€»è¾‘)
    function renderTimetable() {
      const container = document.getElementById('timetableContent');
      container.innerHTML = '';
      
      const currentDateStr = dateUtils.formatDateStr(appState.currentViewDate);
      let dayOfWeek = appState.currentViewDate.getDay();
      if(dayOfWeek === 0) dayOfWeek = 7;
      
      const teacherFilterId = document.getElementById('teacherFilter').value;

      document.getElementById('timetableTitle').textContent = `${dateUtils.getDayName(appState.currentViewDate.getDay())} è¯¾ç¨‹è¡¨`;
      document.getElementById('timetableSubtitle').textContent = currentDateStr;

      let hasConflictGlobal = false;
      let hasCourses = false;

      appState.timeSlots.forEach(slot => {
        // 1. è·å–è¯¥æ—¶æ®µã€è¯¥å¤©çš„æ‰€æœ‰è¯¾ç¨‹ (æœªè¯·å‡)
        let slotStudents = appState.students.filter(s => 
          s.classTime === slot.id && 
          s.attendanceDays.includes(dayOfWeek) &&
          (!s.absentDays || !s.absentDays.includes(currentDateStr))
        );

        if (teacherFilterId !== 'all') {
            slotStudents = slotStudents.filter(s => s.teacherId == teacherFilterId);
        }

        if (slotStudents.length === 0 && teacherFilterId !== 'all') return;
        if (slotStudents.length > 0) hasCourses = true;
        // å¦‚æœå…¨éƒ¨ç©ºä¸”åœ¨ä¸‹åˆ4ç‚¹åï¼Œä¸æ¸²æŸ“ç©ºè¡Œï¼ŒèŠ‚çœç©ºé—´ (å¯é€‰)
        if (slotStudents.length === 0 && slot.id > 12) return;

        // 2. æ£€æµ‹å†²çª (æŒ‰è€å¸ˆåˆ†ç»„)
        const teacherLoads = {};
        slotStudents.forEach(s => {
          if (!teacherLoads[s.teacherId]) teacherLoads[s.teacherId] = { pt_swallow: 0, suspension: 0, total: 0, names: [] };
          teacherLoads[s.teacherId].total++;
          teacherLoads[s.teacherId].names.push(s.name);
          
          if (['ptè¯¾', 'åå’½è¯¾'].includes(s.classType)) teacherLoads[s.teacherId].pt_swallow++;
          if (s.classType === 'æ‚¬åŠè¯¾') teacherLoads[s.teacherId].suspension++;
        });

        const section = document.createElement('div');
        section.className = "animate-fade-in";
        section.innerHTML = `<div class="flex items-center mb-3"><div class="bg-gray-800 text-white rounded px-3 py-1 text-sm font-mono shadow">${slot.time}</div></div>`;
        
        const grid = document.createElement('div');
        grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4";

        // æ¸²æŸ“å¡ç‰‡
        slotStudents.forEach(s => {
          const load = teacherLoads[s.teacherId];
          // å†²çªåˆ¤å®šé€»è¾‘
          // 1. åŒä¸€è€å¸ˆè´Ÿè´£ >1 ä¸ª PT/åå’½
          // 2. åŒä¸€è€å¸ˆè´Ÿè´£ >2 ä¸ª æ‚¬åŠ
          // 3. æ··åˆæƒ…å†µï¼šå¦‚æœæ€»æ•° > 1 ä¸”åŒ…å« PT/åå’½ (ä¸¥æ ¼æ¨¡å¼ï¼šPTæ˜¯ä¸€å¯¹ä¸€ï¼Œä¸èƒ½æ··å…¶ä»–)
          let isConflict = false;
          let conflictMsg = "";

          if (load.pt_swallow > 1) { isConflict = true; conflictMsg = "PT/åå’½è¶…å‘˜"; }
          else if (load.suspension > 2) { isConflict = true; conflictMsg = "æ‚¬åŠè¶…å‘˜"; }
          else if (load.pt_swallow > 0 && load.total > 1) { isConflict = true; conflictMsg = "è¯¾ç¨‹å†²çª"; }

          if (isConflict) hasConflictGlobal = true;

          const colorClass = appState.courseStyles[s.classType] || 'course-default';
          const teacher = appState.teachers.find(t => t.id == s.teacherId);

          const card = document.createElement('div');
          card.className = `border rounded-lg p-3 relative group bg-white card-shadow ${colorClass} ${isConflict ? 'conflict-card' : ''}`;
          
          card.innerHTML = `
            <div class="flex justify-between items-start mb-1">
              <span class="font-bold text-lg">${s.name}</span>
              <span class="badge text-xs px-2 py-0.5 rounded-full font-semibold border border-current opacity-80">${s.classType}</span>
            </div>
            <div class="flex justify-between items-end">
              <div class="text-sm font-medium opacity-90"><i class="fa fa-user-circle-o mr-1"></i>${teacher.name}</div>
              ${isConflict ? `<div class="conflict-text text-xs"><i class="fa fa-warning"></i> ${conflictMsg}</div>` : ''}
            </div>
            <button onclick="editStudent('${s.id}')" class="absolute inset-0 w-full h-full opacity-0 group-hover:opacity-100 bg-black/5 transition cursor-pointer"></button>
          `;
          grid.appendChild(card);
        });

        // æ·»åŠ æŒ‰é’®
        if (teacherFilterId === 'all') {
            const addBtn = document.createElement('div');
            addBtn.className = "border-2 border-dashed border-gray-300 rounded-lg p-3 flex flex-col items-center justify-center text-gray-400 hover:text-primary hover:border-primary hover:bg-blue-50 cursor-pointer transition-all h-20 group";
            addBtn.innerHTML = "<i class='fa fa-plus text-xl mb-1 group-hover:scale-110 transition-transform'></i><span class='text-xs'>æ’è¯¾</span>";
            addBtn.onclick = () => openAddModal(slot.id);
            grid.appendChild(addBtn);
        }

        section.appendChild(grid);
        container.appendChild(section);
      });

      document.getElementById('noCoursesMessage').classList.toggle('hidden', hasCourses);
      document.getElementById('conflictAlert').classList.toggle('hidden', !hasConflictGlobal);
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats() {
      const currentDateStr = dateUtils.formatDateStr(appState.currentViewDate);
      let dayOfWeek = appState.currentViewDate.getDay() || 7;

      const todayStudents = appState.students.filter(s => s.attendanceDays.includes(dayOfWeek));
      const absentCount = todayStudents.filter(s => s.absentDays && s.absentDays.includes(currentDateStr)).length;
      
      document.getElementById('totalStudents').textContent = todayStudents.length;
      document.getElementById('presentStudents').textContent = todayStudents.length - absentCount;
      document.getElementById('sidebarAbsentCount').textContent = absentCount;
    }

    // --- è‡ªåŠ¨æ’è¯¾é€»è¾‘ ---
    function autoSchedule() {
        const name = document.getElementById('formName').value;
        const type = document.getElementById('formType').value;
        const days = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => parseInt(cb.value));

        if (!name) return alert('è¯·å…ˆå¡«å†™å­¦ç”Ÿå§“å');
        if (days.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€å¤©ä¸Šè¯¾æ—¥');

        // ç®€å•ç®—æ³•ï¼šå¯»æ‰¾ç¬¬ä¸€ä¸ªåœ¨é€‰å®šæ—¥å­é‡Œï¼Œæ‰€æœ‰é€‰å®šæ—¥å­éƒ½ä¸å†²çªçš„ (æ—¶é—´+è€å¸ˆ) ç»„åˆ
        // ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬åªé’ˆå¯¹ç¬¬ä¸€ä¸ªé€‰å®šçš„æ—¥å­æ‰¾ç©ºé—²ï¼Œç„¶ååº”ç”¨åˆ°æ‰€æœ‰æ—¥å­
        // å®é™…ä¸Šåº”è¯¥æ‰¾ä¸€ä¸ª (Time, Teacher) pair that is valid for ALL selected days.

        const targetDay = days[0]; // ç®€åŒ–ï¼šä»¥ç¬¬ä¸€å¤©ä¸ºåŸºå‡†å¯»æ‰¾ç©ºä½
        
        let bestSlot = null;
        let bestTeacher = null;

        // éšæœºæ‰“ä¹±é¡ºåºä»¥å®ç°â€œéšæœºåˆ†é…â€
        const shuffledSlots = [...appState.timeSlots].sort(() => 0.5 - Math.random());
        const shuffledTeachers = [...appState.teachers].sort(() => 0.5 - Math.random());

        for (let slot of shuffledSlots) {
            for (let teacher of shuffledTeachers) {
                // æ£€æŸ¥è¯¥ è€å¸ˆ+æ—¶é—´ æ˜¯å¦æœ‰ç©º
                // æ¨¡æ‹Ÿæ£€æŸ¥å†²çª
                const existingStudents = appState.students.filter(s => 
                    s.classTime === slot.id && 
                    s.teacherId === teacher.id && 
                    s.attendanceDays.includes(targetDay)
                );
                
                let isFull = false;
                
                // å†²çªè§„åˆ™
                let ptCount = 0;
                let susCount = 0;
                existingStudents.forEach(s => {
                    if (['ptè¯¾', 'åå’½è¯¾'].includes(s.classType)) ptCount++;
                    if (s.classType === 'æ‚¬åŠè¯¾') susCount++;
                });

                if (['ptè¯¾', 'åå’½è¯¾'].includes(type)) {
                    // å¦‚æœæˆ‘è¦æ’PTï¼Œè€å¸ˆå¿…é¡»å®Œå…¨ç©ºé—² (æˆ–è€…ç°æœ‰æ˜¯æ‚¬åŠä¸”æœªæ»¡? ä¸ºäº†å®‰å…¨ï¼ŒPTé€šå¸¸ç‹¬å )
                    if (existingStudents.length > 0) isFull = true; 
                } else if (type === 'æ‚¬åŠè¯¾') {
                    // å¦‚æœæˆ‘è¦æ’æ‚¬åŠï¼Œä¸èƒ½æœ‰PTï¼Œæ‚¬åŠä¸èƒ½è¶…è¿‡1ä¸ª (åŠ ä¸Šæˆ‘ä¹Ÿå°±2ä¸ª)
                    if (ptCount > 0) isFull = true;
                    if (susCount >= 2) isFull = true;
                } else {
                    // å¾‹åŠ¨è¯¾ç­‰ï¼Œå‡è®¾åªèƒ½1å¯¹1
                    if (existingStudents.length > 0) isFull = true;
                }

                if (!isFull) {
                    bestSlot = slot.id;
                    bestTeacher = teacher.id;
                    break;
                }
            }
            if (bestSlot) break;
        }

        if (bestSlot && bestTeacher) {
            document.getElementById('formTime').value = bestSlot;
            document.getElementById('formTeacher').value = bestTeacher;
            // é«˜äº®æç¤º
            const tName = appState.teachers.find(t=>t.id==bestTeacher).name;
            const sTime = appState.timeSlots.find(s=>s.id==bestSlot).time;
            alert(`å·²è‡ªåŠ¨åŒ¹é…ç©ºé—²æ—¶æ®µï¼š\n${tName} - ${sTime}`);
        } else {
            alert('æœªæ‰¾åˆ°å®Œå…¨æ— å†²çªçš„ç©ºé—²æ—¶æ®µï¼Œè¯·æ‰‹åŠ¨å®‰æ’æˆ–è°ƒæ•´æ¡ä»¶ã€‚');
        }
    }

    // --- ä¸šåŠ¡æ“ä½œ ---

    function openAddModal(preTimeId) {
      document.getElementById('studentForm').reset();
      document.getElementById('formStudentId').value = '';
      document.getElementById('addModalTitle').textContent = 'æ·»åŠ æ–°è¯¾ç¨‹';
      if(preTimeId) document.getElementById('formTime').value = preTimeId;
      document.getElementById('btnDeleteStudent').classList.add('hidden');
      
      // é»˜è®¤é€‰ä¸­å½“å‰å‘¨å‡ 
      const currentDayOfWeek = appState.currentViewDate.getDay() || 7;
      const cb = document.querySelector(`input[name="days"][value="${currentDayOfWeek}"]`);
      if(cb) cb.checked = true;

      document.getElementById('addStudentModal').classList.remove('hidden');
    }

    function editStudent(id) {
      const s = appState.students.find(st => st.id === id);
      document.getElementById('formStudentId').value = s.id;
      document.getElementById('formName').value = s.name;
      document.getElementById('formTime').value = s.classTime;
      document.getElementById('formType').value = s.classType;
      document.getElementById('formTeacher').value = s.teacherId;
      document.getElementById('formNotes').value = s.notes || '';
      
      const cbs = document.querySelectorAll('input[name="days"]');
      cbs.forEach(cb => cb.checked = s.attendanceDays.includes(parseInt(cb.value)));

      document.getElementById('addModalTitle').textContent = 'ç¼–è¾‘/è°ƒæ•´è¯¾ç¨‹';
      document.getElementById('btnDeleteStudent').classList.remove('hidden');
      document.getElementById('btnDeleteStudent').onclick = () => {
          if(confirm('ç¡®å®šåˆ é™¤è¯¥è¯¾ç¨‹å®‰æ’å—ï¼Ÿ')) {
              appState.students = appState.students.filter(st => st.id !== id);
              saveData(); updateUI();
              document.getElementById('addStudentModal').classList.add('hidden');
          }
      };

      document.getElementById('addStudentModal').classList.remove('hidden');
    }

    // è¡¨å•æäº¤
    document.getElementById('studentForm').onsubmit = (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const days = [...formData.getAll('days')].map(Number);
      
      if (days.length === 0) return alert('è¯·é€‰æ‹©ä¸Šè¯¾æ—¥');
      
      const isEdit = document.getElementById('formStudentId').value;
      
      const newData = {
        id: isEdit || (Date.now() + Math.random().toString(36).substr(2)),
        name: formData.get('name'),
        classTime: parseInt(formData.get('classTime')),
        classType: formData.get('classType'),
        teacherId: parseInt(formData.get('teacherId')),
        attendanceDays: days,
        notes: formData.get('notes'),
        absentDays: isEdit ? (appState.students.find(s=>s.id===isEdit).absentDays || []) : []
      };

      if (isEdit) {
        const idx = appState.students.findIndex(s => s.id === isEdit);
        appState.students[idx] = newData;
      } else {
        appState.students.push(newData);
      }
      
      saveData();
      updateUI();
      document.getElementById('addStudentModal').classList.add('hidden');
    };

    // --- äº‹ä»¶ç»‘å®š ---
    function bindEvents() {
      // æ˜ŸæœŸ/æ—¥æœŸåˆ‡æ¢
      document.getElementById('prevWeekBtn').onclick = () => {
        appState.currentViewDate = dateUtils.addDays(appState.currentViewDate, -7);
        updateUI();
      };
      document.getElementById('nextWeekBtn').onclick = () => {
        appState.currentViewDate = dateUtils.addDays(appState.currentViewDate, 7);
        updateUI();
      };
      document.getElementById('resetDateBtn').onclick = () => {
        appState.currentViewDate = new Date();
        updateUI();
      };
      
      // ç­›é€‰
      document.getElementById('teacherFilter').onchange = updateUI;

      // æ¨¡æ€æ¡†å¼€å…³
      document.getElementById('closeAddStudentModal').onclick = () => document.getElementById('addStudentModal').classList.add('hidden');
      document.getElementById('addStudentBtn').onclick = () => openAddModal();
      
      document.getElementById('btnAutoSchedule').onclick = autoSchedule;

      // å…¨éƒ¨å­¦ç”Ÿåˆ—è¡¨é€»è¾‘
      document.getElementById('showAllStudentsBtn').onclick = () => {
        const tbody = document.getElementById('allStudentsTableBody');
        tbody.innerHTML = '';
        appState.students.sort((a,b) => a.classTime - b.classTime).forEach(s => {
             const tr = document.createElement('tr');
             const teacher = appState.teachers.find(t=>t.id==s.teacherId).name;
             const time = appState.timeSlots.find(slot=>slot.id==s.classTime).time;
             const daysStr = s.attendanceDays.map(d=>['','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'][d]).join(', ');
             const typeClass = appState.courseStyles[s.classType] || ''; // è·å–é¢œè‰²ç±»
             
             tr.className = "hover:bg-gray-50 group border-b border-gray-100";
             tr.innerHTML = `
                <td class="px-6 py-3 font-medium text-gray-800">${s.name}</td>
                <td class="px-6 py-3"><span class="badge ${typeClass.replace('course-','bg-').replace('text-','text-')} px-2 py-1 rounded text-xs">${s.classType}</span></td>
                <td class="px-6 py-3 text-gray-600 font-mono text-xs">${time}</td>
                <td class="px-6 py-3 text-gray-600">${teacher}</td>
                <td class="px-6 py-3 text-xs text-gray-500">${daysStr}</td>
                <td class="px-6 py-3 text-right">
                   <button onclick="editStudent('${s.id}');document.getElementById('allStudentsModal').classList.add('hidden')" class="text-blue-500 hover:text-blue-700 text-sm">ç¼–è¾‘</button>
                </td>
             `;
             tbody.appendChild(tr);
        });
        document.getElementById('allStudentsModal').classList.remove('hidden');
      };

      // æœç´¢åŠŸèƒ½
      document.getElementById('searchAllInput').oninput = (e) => {
         const term = e.target.value.toLowerCase();
         document.querySelectorAll('#allStudentsTableBody tr').forEach(row => {
             row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
         });
      };

      // çŠ¶æ€ç®¡ç†æ¨¡æ€æ¡† (è¯·å‡é€»è¾‘)
      document.getElementById('openStatusModalBtn').onclick = () => {
         renderStatusList();
         document.getElementById('statusModal').classList.remove('hidden');
      };
      document.getElementById('closeStatusModal').onclick = () => document.getElementById('statusModal').classList.add('hidden');
      
      // æ•™å¸ˆç®¡ç†æ¨¡æ€æ¡†
      document.getElementById('teacherManagementBtn').onclick = () => {
         const list = document.getElementById('teacherList');
         list.innerHTML = '';
         const dateStr = dateUtils.formatDateStr(appState.currentViewDate);
         const day = appState.currentViewDate.getDay() || 7;
         
         appState.teachers.forEach(t => {
             const courses = appState.students.filter(s => 
                s.teacherId === t.id && 
                s.attendanceDays.includes(day) &&
                (!s.absentDays || !s.absentDays.includes(dateStr))
             ).sort((a,b) => a.classTime - b.classTime);
             
             const div = document.createElement('div');
             div.className = "border rounded p-3 bg-white mb-2";
             let html = `<div class="font-bold flex justify-between"><span>${t.name}</span> <span class="text-xs font-normal text-gray-500">ä»Šæ—¥ ${courses.length} èŠ‚</span></div>`;
             if(courses.length > 0) {
                 html += '<div class="mt-2 space-y-1">';
                 courses.forEach(c => {
                    const time = appState.timeSlots.find(s=>s.id==c.classTime).time;
                    html += `<div class="text-xs flex justify-between text-gray-600"><span>${time}</span> <span>${c.name} (${c.classType})</span></div>`;
                 });
                 html += '</div>';
             } else {
                 html += '<div class="text-xs text-gray-400 mt-1">ä»Šæ—¥æ— è¯¾</div>';
             }
             div.innerHTML = html;
             list.appendChild(div);
         });
         document.getElementById('teacherManagementModal').classList.remove('hidden');
      };
      
      // æ ‡ç­¾åˆ‡æ¢
      document.getElementById('tabAbsent').onclick = (e) => {
         document.getElementById('absentListPanel').classList.remove('hidden');
         document.getElementById('presentListPanel').classList.add('hidden');
         e.target.className = "flex-1 py-3 text-center font-medium border-b-2 border-primary text-primary";
         document.getElementById('tabPresent').className = "flex-1 py-3 text-center font-medium text-gray-500 hover:bg-gray-50";
      };
      document.getElementById('tabPresent').onclick = (e) => {
         document.getElementById('absentListPanel').classList.add('hidden');
         document.getElementById('presentListPanel').classList.remove('hidden');
         e.target.className = "flex-1 py-3 text-center font-medium border-b-2 border-primary text-primary";
         document.getElementById('tabAbsent').className = "flex-1 py-3 text-center font-medium text-gray-500 hover:bg-gray-50";
      };
    }

    function renderStatusList() {
        const absentList = document.getElementById('absentListPanel');
        const presentList = document.getElementById('presentListPanel');
        absentList.innerHTML = '';
        presentList.innerHTML = '';
        
        const dateStr = dateUtils.formatDateStr(appState.currentViewDate);
        const day = appState.currentViewDate.getDay() || 7;
        
        const todayStudents = appState.students.filter(s => s.attendanceDays.includes(day));
        
        // ç¼ºå‹¤åˆ—è¡¨
        const absents = todayStudents.filter(s => s.absentDays && s.absentDays.includes(dateStr));
        if (absents.length === 0) absentList.innerHTML = '<div class="text-gray-400 text-center py-4">æ— è¯·å‡è®°å½•</div>';
        absents.forEach(s => {
            const div = document.createElement('div');
            div.className = "flex justify-between items-center bg-red-50 p-3 rounded border border-red-100";
            div.innerHTML = `<div><div class="font-bold text-gray-800">${s.name}</div><div class="text-xs text-red-600">å·²è¯·å‡</div></div><button onclick="toggleLeave('${s.id}')" class="text-xs bg-white border border-red-200 text-red-600 px-2 py-1 rounded">æ¢å¤ä¸Šè¯¾</button>`;
            absentList.appendChild(div);
        });

        // æ­£å¸¸åˆ—è¡¨
        const presents = todayStudents.filter(s => !s.absentDays || !s.absentDays.includes(dateStr));
        if (presents.length === 0) presentList.innerHTML = '<div class="text-gray-400 text-center py-4">ä»Šæ—¥æ— è¯¾</div>';
        presents.forEach(s => {
            const div = document.createElement('div');
            div.className = "flex justify-between items-center bg-white p-3 rounded border border-gray-100 shadow-sm";
            div.innerHTML = `<div><div class="font-bold text-gray-800">${s.name}</div><div class="text-xs text-gray-500">${appState.timeSlots.find(slot=>slot.id==s.classTime).time}</div></div><button onclick="toggleLeave('${s.id}')" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-red-50 hover:text-red-600">è®¾ä¸ºè¯·å‡</button>`;
            presentList.appendChild(div);
        });
    }

    function toggleLeave(id) {
        const s = appState.students.find(st => st.id === id);
        const dateStr = dateUtils.formatDateStr(appState.currentViewDate);
        
        if (!s.absentDays) s.absentDays = [];
        
        if (s.absentDays.includes(dateStr)) {
            s.absentDays = s.absentDays.filter(d => d !== dateStr);
        } else {
            s.absentDays.push(dateStr);
        }
        saveData();
        updateUI();
        renderStatusList();
    }

    // Run
    init();
  </script>
<!-- ================= æ•°æ®åŒæ­¥æ’ä»¶å¼€å§‹ ================= -->
<div id="data-manager" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-family: sans-serif;">
    <input type="file" id="importFile" style="display: none;" onchange="importData(this)">
    
    <button onclick="exportData()" style="
        padding: 12px 24px; 
        background: #28a745; 
        color: white; 
        border: none; 
        border-radius: 50px; 
        margin-right: 10px; 
        cursor: pointer; 
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.1s;">
        ğŸ“¤ å¯¼å‡ºæ•°æ® (å‘ç»™æ‰‹æœº)
    </button>
    
    <button onclick="document.getElementById('importFile').click()" style="
        padding: 12px 24px; 
        background: #007bff; 
        color: white; 
        border: none; 
        border-radius: 50px; 
        cursor: pointer; 
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.1s;">
        ğŸ“¥ å¯¼å…¥æ•°æ® (æ¥æ”¶æ–‡ä»¶)
    </button>
</div>

<script>
// å¯¼å‡ºåŠŸèƒ½ï¼šæŠŠæ‰€æœ‰æ’è¯¾æ•°æ®æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶
function exportData() {
    if (localStorage.length === 0) {
        alert('âš ï¸ å½“å‰æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
        return;
    }
    const data = JSON.stringify(localStorage);
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    
    // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶åï¼Œé˜²æ­¢æ··æ·†
    const date = new Date();
    const timeStr = `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥_${date.getHours()}ç‚¹${date.getMinutes()}åˆ†`;
    const fileName = `æ’è¯¾æ•°æ®å¤‡ä»½_${timeStr}.json`;
    
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`âœ… æ•°æ®å·²å¯¼å‡ºä¸ºï¼š\n${fileName}\n\nè¯·å°†æ­¤æ–‡ä»¶é€šè¿‡å¾®ä¿¡/QQå‘é€åˆ°å¦ä¸€å°è®¾å¤‡ã€‚`);
}

// å¯¼å…¥åŠŸèƒ½ï¼šè¯»å–æ–‡ä»¶å¹¶è¦†ç›–å½“å‰æ•°æ®
function importData(input) {
    const file = input.files,[object Object],;
    if (!file) return;

    if (!confirm('âš ï¸ é«˜èƒ½é¢„è­¦ï¼š\n\nå¯¼å…¥æ–°æ•°æ®å°†ã€è¦†ç›–å¹¶æ¸…ç©ºã€‘å½“å‰è®¾å¤‡ä¸Šçš„æ‰€æœ‰æ’è¯¾è®°å½•ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        input.value = ''; // å–æ¶ˆé€‰æ‹©
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // 1. æ¸…ç©ºå½“å‰æ—§æ•°æ®
            localStorage.clear();
            
            // 2. å†™å…¥æ–°æ•°æ®
            for (let key in data) {
                localStorage.setItem(key, data[key]);
            }
            
            alert('ğŸ‰ æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°...');
            location.reload(); // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ•°æ®
            
        } catch (err) {
            alert('âŒ å¯¼å…¥å¤±è´¥ï¼\nè¯·ç¡®ä¿æ‚¨ä¸Šä¼ çš„æ˜¯æ­£ç¡®çš„ .json å¤‡ä»½æ–‡ä»¶ã€‚');
            console.error(err);
        }
    };
    reader.readAsText(file);
}
</script>
<!-- ================= æ•°æ®åŒæ­¥æ’ä»¶ç»“æŸ ================= -->
</body>
</html>